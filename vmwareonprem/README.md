# Облако VMware - реверс архитектуры из vCloud Director
***
Зависимости модуля: **seaf-core**

Описание услуг предоставляемых провайдером Cloud.ru на базе **Облака VMware** и в любом другом провайдере на базе VMware (vCloud Director). 


## Быстрый старт

Модуль позволяет выгружать и использовать данные о базовой инфраструктуре компании размещаемой в облачном провайдере на базе **VMware** с API vCloud Director.
Из полученных данных формируются реестры потребляемых услуг и вся необходимая для работы с инфраструктурой информация, в том числе сетевые схемы.

### Модуль отвечает на вопросы
- **Как устроена моя инфраструктура?**  
  Модуль позволяет иметь под рукой актуальный срез информации о своей инфраструктуре. Поможет оперативно ответить на вопросы коллег или руководства.
- **Настроил ли я резервную копию или правило на фаере?**  
  На страницах сущностей доступна информации о расписании резервного копирования, сетевых правилах и т.д.
- **Кибера просят показать где развернуто это приложение и соответсвует ли проектное описание реальному?**  
  Все сущности которые могут являться компонентами прикладных сервисов (СУБД, брокеры, балансировщики, виртуальные машины) могут быть привязаны к прикладным сервисам с помощью сущности **links**.

### Как подготовить данные?

Сущности с 1 по 8 (в таблице ниже) заполняются автоматически с помощью Python скрипта поставляемого в пакете.

    Скрипт поставляется as-is как пример реализации  


Для того чтобы корректно произвести выгрузку и заполнить сущности негенерируемые автоматически вам потребуется:
- Создать объект сущности ЦОД базовой метамодели технической архитектуры (**seaf.ta.services.dc**), идентификатор данного объекта необходимо ввести в атрибут DC для заполняемых вручную объектов и использовать в скрипте для выгрузки данных.
- Заполнить объект сущности Связь (**seaf.ta.reverse.general.links**) и привязать Прикладные компоненты к Техническим компонентам в метамодели расширения IaaS.Reverse.

Пример заполнения объекта сущности Связь
```yaml
seaf.ta.reverse.general.links:
    sber.berezka.links.home_cinema.auth:
       app_id: sber.berezka.home_cinema.auth
       reverse_ta_id:
         - sber.berezka.ecss.62f713a4-1139-461f-8053-1df267861aef
         - sber.berezka.ecss.729d3b73-350c-4987-86ed-01d36b719c57
         - sber.berezka.rdss.0e493e5847714a14a313e215d9e59b15in03
         - sber.berezka.elbs.ad9af3b6-fd82-404e-8d6c-466660e92329
         - sber.berezka.ecss.e5e60a69-0653-4297-8799-ea0df4f0cacc
```
### Запуск скрипта выгрузки
1. Создать пользователя в Cloud.ru Облако VMware с правами на чтение  для подключения
к API. Подробнее: [Cloud.ru](https://cloud.ru/ru/docs/vdc/ug/topics/api.html)
2. Ввести полученный токен в конфигурационный файл скрипта (в папке bin данного пакета, там содержится инструкция).

        Помните, это небезопасно и лучше использовать Vault или другое хранилище ключей!
3. Запустить скрипт **cloud-enterprise.py**

4. В результате выполнения скрипта данные будут сохранены в папку заданную в конфигурации


## Структура каталогов
```console

|- _metamodel_                      - Подключенные пакеты метамоделей
|  |- iaas                          - Пакет метамодели
|  |  |- cloud.ru                   - Модель провайдера
|  |  |  |- vmwarecloud             - Регион или тип услуги (vmware/aws)
|  |  |  |  |- entities             - Сущности метамодели
|  |  |  |  |- functions            - Запросы написанные на JSONata
|  |  |  |  |- datasets             - Переиспользуемые датасеты - появится по мере необходимости
|  |  |  |  |- menu                 - Структура меню сущностей метамодели
|  |  |  |  |- presentations        - Презентационный слой сущностей метамодели
```
## Сущности

| №    | **Объект**   | **Наименование сущности**              | **Описание**                                                                          |
|------|--------------|----------------------------------------|---------------------------------------------------------------------------------------|
| 1    | **org**      | 	seaf.ta.reverse.vmwarecloud.orgs      | 	Организация (может быть множество орагнизаций внутри тенанта)                        |
| 2    | **orgnet**   | 	seaf.ta.reverse.vmwarecloud.orgnets	  | Сети организации                                                                      |
| 3    | **vdcgroup** | 	seaf.ta.reverse.vmwarecloud.vdcgroups	 | Группы виртулаьных датацентров                                                        |
| 4    | **vdc**      | 	seaf.ta.reverse.vmwarecloud.vdcs	     | Виртулаьные датаценты                                                                 |
| 5    | **egw**      | 	seaf.ta.reverse.vmwarecloud.egws	     | Edge Gateways                                                                         |
| 6    | **vapp**     | 	seaf.ta.reverse.vmwarecloud.vapps	    | vApp (виртулаьные приложения)                                                         |
| 7    | **vappnet**  | 	seaf.ta.reverse.vmwarecloud.vappnets	 | Сети vApp                                                                             |
| 8    | **server**   | 	seaf.ta.components.server	            | Виртуальные машины (расширены в блоке reverse:)                                       |
| 9  | **egws_nat** | 	seaf.ta.reverse.vmwarecloud.egws_nat	 | Правила NAT на Edge Gateway                                                           |
| 10 | **egws_fw**  | 	seaf.ta.reverse.vmwarecloud.egws_fw	  | Правила FW на Edge Gateway                                                            |
| 11(*) | **links**    | seaf.ta.reverse.general.links          | Сущность-связь прикладного компонента к техническому компоненту (заполняется вручную) |

(*) - Сущность для связи с прикладными или техническими компонентами


## Схема
![Метамодель](@entity/seaf.ta.reverse.general/metamodel_vmwarecloud)