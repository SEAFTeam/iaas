# On-Premise кластер VMware - реверс архитектуры с помощью pyVmomi
***
Зависимости модуля: **seaf-core**

Описание услуг предоставляемых провайдером VMware


## Быстрый старт

Модуль позволяет выгружать и использовать данные о базовой инфраструктуре компании размещаемой в локальном кластере виртуализации на базе **VMware** с помощью бибилотеки pyVmomi.

### Модуль будет полезен
 - Системным администраторам
 - Архитекторам инфраструктуры
 - Экспертам кибербезопасности

### Как подготовить данные?

Сущности с 1 по 7 (в таблице ниже) заполняются автоматически с помощью Python скрипта поставляемого в пакете.

    Скрипт поставляется as-is как пример реализации  

Для того чтобы корректно произвести выгрузку и заполнить сущности негенерируемые автоматически вам потребуется:
- Создать объект сущности ЦОД базовой метамодели технической архитектуры (**seaf.ta.services.dc**), идентификатор данного объекта необходимо ввести в атрибут DC для заполняемых вручную объектов и использовать в скрипте для выгрузки данных.
- Заполнить объект сущности Связь (**seaf.ta.reverse.general.links**) и привязать Прикладные компоненты к Техническим компонентам в метамодели расширения IaaS.Reverse.

Пример заполнения объекта сущности Связь
```yaml
seaf.ta.reverse.general.links:
    sber.berezka.links.home_cinema.auth:
       app_id: sber.berezka.home_cinema.auth
       reverse_ta_id:
         - sber.berezka.ecss.62f713a4-1139-461f-8053-1df267861aef
         - sber.berezka.ecss.729d3b73-350c-4987-86ed-01d36b719c57
         - sber.berezka.rdss.0e493e5847714a14a313e215d9e59b15in03
         - sber.berezka.elbs.ad9af3b6-fd82-404e-8d6c-466660e92329
         - sber.berezka.ecss.e5e60a69-0653-4297-8799-ea0df4f0cacc
```
### Запуск скрипта выгрузки
1. Создать пользователя в vCenter с правами на чтение для подключения к API.
2. Сконфигурировать запуск скрипта:
```console
[vsphere]
host = xx.xx.xx.xx
user = username@domain.zone
pwd = [password]

[params]
domain = [company prefix] # berezka
root = [root prefix] # sber
exportpath = [path to export folder]
location = [идентификатор dc]
```
        Помните, хранить пароли в скриптах небезопасно и лучше использовать Vault или другое хранилище ключей!
3. Запустить скрипт **vcenter_api.py**

4. В результате выполнения скрипта данные будут сохранены в папку заданную в конфигурации


## Структура каталогов
```console

|- _metamodel_                      - Подключенные пакеты метамоделей
|  |- iaas                          - Пакет метамодели
|  |  |- vmwareonprem               - Папка метамодели для vCenter/vSphere
|  |  |  |- entities                - Сущности метамодели
|  |  |  |- functions               - Запросы написанные на JSONata
|  |  |  |- menu                    - Структура меню сущностей метамодели
|  |  |  |- presentations           - Презентационный слой сущностей метамодели
|  |  |- general
|  |  |  |- bin
|  |  |  |  |- vmwareonprem         - Скрипты и конфиг экспорта
```
## Сущности

| №    | **Объект**       | **Наименование сущности**                   | **Описание**                                                                          |
|------|------------------|---------------------------------------------|---------------------------------------------------------------------------------------|
| 1    | **netwroks**     | 	seaf.ta.services.network	                  | Сети                                                                                  |
| 2    | **vdc**          | 	seaf.ta.reverse.vmwareonprem.vdcs	         | Виртулаьные датаценты                                                                 |
| 3    | **dvportgroups** | 	seaf.ta.reverse.vmwareonprem.dvportgroups	 | DV порт группы                                                                        |
| 4    | **vapp**         | 	seaf.ta.reverse.vmwareonprem.vapps	        | vApp                                                                                  |
| 5    | **dvswitches**   | 	seaf.ta.components.network	                | DV Switch                                                                             |
| 6    | **server**       | 	seaf.ta.components.server	                 | Виртуальные машины (расширены в блоке reverse:)                                       |
| 7    | **hosts**        | 	seaf.ta.reverse.vmwareonprem.hosts	        | Хосты виртуализации                                                                   |
| 8(*) | **links**        | seaf.ta.reverse.general.links               | Сущность-связь прикладного компонента к техническому компоненту (заполняется вручную) |

(*) - Сущность для связи с прикладными или техническими компонентами


## Схема
![Метамодель](@entity/seaf.ta.reverse.general/metamodel_vmwareonprem)