entities:
  seaf.ta.reverse.general.systems:
    presentations:
      systems_ta:
        type: markdown
        template: templates/systems.md
        source: >
          (
              $systems := $.components.$spread()[*.type = 'service'];
              $components := $.components.$spread()[*.type = 'component'];
              $system := [$systems.$spread().$merge([$.*, {"id": $keys($), "domain": $split($keys($), ".")[0]}])];
              $system[id=$params.id];
          )

      components:
        type: table
        headers:
          - value: name
            text: Наименование
            sortable: true
            align: left
            link: link
            width: 150
          - value: type
            text: Тип компонента
            sortable: true
            align: left
            width: 200
          - value: dc
            text: Провайдер/Услуга
            width: 200
        origin: seaf.ta.reverse.general.allobjects
        source: >
          (
              $systems := $$.components.$spread()[*.type = 'service'];
              $links := $$."seaf.ta.reverse.general.links";
              $cdcs := $$."seaf.ta.services.dc";
              $entities := $;
              $system := $systems[$keys()[0] = $params.id];
              $regexp := $exists($system) = true ? $eval("/" & $split($system.$keys()[0], '.')[-1] & "\\./");
              $components := $.components.$spread()[*.type = 'component'][$regexp($keys()[0])];
              $tech_components := $components.$spread().(
                  $app_id := $keys()[0];
                  $links.$spread()[*.app_id = $app_id].*.reverse_ta_id
              );
              $tech_components.(
                  $id := $;
                  $entities.(
                      $entity := $keys()[0];
                      $type := $$.entities.$spread()[$keys()[0] = $entity].*.title;
                      $.*.$spread()[$keys()[0] = $id].(
                          $vpc_id := $.*.vpc_id;
                          $vpc := $cvpcs.$spread()[*.id = $vpc_id].*.name;
                          $dc_id := $.*.DC;
                          $dc := $cdcs.$spread()[$keys()[0] = $dc_id].*.dc_name;
                          {
                              'name': $.*.name,
                              'type': $type,
                              'vpc': $vpc,
                              'az': $.*.az,
                              'tenant': $.*.tenant,
                              'dc': $dc
                          }
                      )
                  )
              )
          )