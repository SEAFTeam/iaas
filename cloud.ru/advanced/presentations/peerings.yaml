entities:
  seaf.ta.reverse.cloud_ru.advanced.peerings:
    presentations:
      table_view:
        type: table
        headers:
          - value: name
            text:  Название пиринга
            width: 20%
            sortable: true
          - value: request_vpc
            text: Источник VPC
            width: 20%
            sortable: true
          - value: accept_vpc
            text: Назначение VPC
            width: 20%
            sortable: true
          - value: description
            text: Описание
            width: 20%
            sortable: true
          - value: status
            text: Состояние
            width: 20%
            sortable: true
          - value: tenant
            text: Тенант
            width: 20%
            sortable: true
          - value: dc
            text: Датацентр
            width: 20%
            sortable: true
        source: >
          (   
              $ctx := $params;
              $domain_matcher := $eval('/^' & $ctx.domain & '.*/');
              $peerings := $."seaf.ta.reverse.cloud_ru.advanced.peerings" ~> $each(function($v, $k){$domain_matcher($k) ? {$k:$v}});
              $vpcs := $."seaf.ta.reverse.cloud_ru.advanced.vpcs" ~> $each(function($v, $k){$domain_matcher($k) ? {$k:$v}});
              $dcs := $."seaf.ta.services.dc" ~> $each(function($v, $k){$domain_matcher($k) ? {$k:$v}});
              [$peerings.(
                      $rvpc_id := $.*.request_vpc;
                      $avpc_id := $.*.accept_vpc;
                      $dc_id := $.*.DC;
                      $request_vpc := $vpcs ~> $filter(function($v){$v.*.id = $rvpc_id});
                      $accept_vpc := $vpcs ~> $filter(function($v){$v.*.id = $avpc_id});
                      $dc := $dcs ~> $filter(function($v){$v.$keys() = $dc_id});
                      $ ~> | $.* | {'request_vpc': $request_vpc.*.name, 'accept_vpc': $accept_vpc.*.name, 'dc':$dc.*.title} |
                  ).*
              ]
          )