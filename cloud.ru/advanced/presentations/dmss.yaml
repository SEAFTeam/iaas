entities:
  seaf.ta.reverse.cloud_ru.advanced.dmss:
    presentations:
      table_view:
        type: table
        headers:
          - value: name
            text: Наименование кластера
            width: 20%
            sortable: true
            link: link
          - value: flavor
            text: Спецификация
            width: 20%
          - value: ha
            text: Высокая доступность
            width: 20%
          - value: address
            text: IP адрес
            width: 20%
          - value: port
            text: Порт
            width: 20%
          - value: management
            text: Management URL
            width: 20%
          - value: subnet
            text: Подсеть
            width: 20%
          - value: vpc
            text: VPC
            width: 20%
          - value: az
            text: Зоны доступности
            width: 20%
          - value: dc
            text: Датацентр
            width: 20%
        source: >
          (
              $ctx := $params;
              $domain_matcher := $eval('/^' & $ctx.domain & '.*/');
              $cdmss := $."seaf.ta.reverse.cloud_ru.advanced.dmss" ~> $each(function($v, $k){$domain_matcher($k) ? {$k:$v}});
              $csubnets := $."seaf.ta.reverse.cloud_ru.advanced.subnets" ~> $each(function($v, $k){$domain_matcher($k) ? {$k:$v}});
              $cvpcs := $."seaf.ta.reverse.cloud_ru.advanced.vpcs" ~> $each(function($v, $k){$domain_matcher($k) ? {$k:$v}});
              $cdcs := $."seaf.ta.services.dc" ~> $each(function($v, $k){$domain_matcher($k) ? {$k:$v}});
              [$cdmss.$spread().(
                  $subnet_id := $.*.subnet_id;
                  $vpc_id := $.*.vpc_id;
                  $id := $keys()[0];
                  $dms_dc := $.*.DC;
                  $dc := $cdcs.$spread()[$keys()[0] = $dms_dc].*.title;
                  {
                      'name': $.*.name,
                      'engine': $.*.engine,
                      'flavor': $.*.specification,
                      'ha': $.*.type,
                      'address': $.*.address,
                      'port': $.*.port,
                      'subnet': $csubnets.$spread()[$.*.id = $subnet_id].*.name,
                      'vpc': $cvpcs.$spread()[$.*.id = $vpc_id].*.name,
                      'management': $.*.management,
                      'az': $join($.*.available_az, ', '),
                      'dc': $dc,
                      'link': '/entities/seaf.ta.reverse.cloud_ru.advanced.dmss/dms_md?id=' & $id & '&domain=' & $ctx.domain
                  }
              )]
          )
      dms_md:
        type: markdown
        template: templates/dms.md
        source: >
          (
              $ctx := $params;
              $domain_matcher := $eval('/^' & $ctx.domain & '.*/');
              $dms := $."seaf.ta.reverse.cloud_ru.advanced.dmss".$spread()[$keys()[0] = $ctx.id];
              $csubnets := $."seaf.ta.reverse.cloud_ru.advanced.subnets" ~> $each(function($v, $k){$domain_matcher($k) ? {$k:$v}});
              $cvpcs := $."seaf.ta.reverse.cloud_ru.advanced.vpcs" ~> $each(function($v, $k){$domain_matcher($k) ? {$k:$v}});
              $subnet_id := $dms.*.subnet_id;
              $vpc_id := $dms.*.vpc_id;
              $subnet := $csubnets.$spread()[$.*.id = $subnet_id].*.name;
              $vpc := $csubnets.$spread()[$.*.id = $subnet_id].*.name;
              $array := $dms.*;
              $dc := $."seaf.ta.services.dc".$spread()[$keys()[0] = $dms.*.DC].*.title;
              $array := $array ~> | $ |{'id': $dms.$keys(), 'domain': $ctx.domain, 'DC': $dc, 'subnet': $subnet, 'vpc': $vpc}|;
          )
