functions:
  reverse_advanced_ecss:
    title: Список виртуальных машин Advanced
    params:
      - alias: dataset
        type: object
        title: Озеро данных
        required: true  # Признак обязательности параметра функции
      - alias: domain
        type: string
        title: Домен организации
        required: false  # Признак обязательности параметра функции
    code: >
      (
          $domain := domain;
          $domain_matcher := $eval('/^' & $domain & '.*/');
      
          $vms_entity := dataset."seaf.ta.reverse.general".config.entities.advanced.ecss.model;
          $vms_view := dataset."seaf.ta.reverse.general".config.entities.advanced.ecss.view;
      
          $vms := ($lookup(dataset, $vms_entity) ~> $each(function($v, $k){$domain_matcher($k) ? {$k:$v}}));
      
          [[$vms.$spread().{
              'id': $keys(),
              'vm': *
          }].(
              $disks := $join(vm.disks.(*.device & ' - ' & *.type & ' - ' & *.size & 'Gb'), '\n');
              $addresses := $count(vm.addresses) > 1 ? $join(vm.addresses.($ != null ? $), ', ') : vm.addresses;
              $subnets := $count(vm.subnets) > 1 ? $join(vm.subnets.($ != null ? $), ', ') : vm.subnets;
              {
                  'id': id,
                  'short_id': vm.id,
                  'title': vm.title,
                  'description': vm.description,
                  'os_type': vm.os.type,
                  'os_bit': vm.os.bit,
                  'cpu_qty': vm.cpu.cores,
                  'ram': vm.ram / 1024,
                  'flavor': vm.flavor,
                  'disks': $disks,
                  'nic_qty': vm.nic_qty,
                  'addresses': $addresses,
                  'subnet_ids': $subnets,
                  'az': vm.az,
                  'tags': vm.tags,
                  'vpc': vm.vpc_id,
                  'tenant': vm.tenant,
                  'link': '/entities/' & $vms_view & '/card?id=' & id & '&domain=' & $domain,
                  'entity': $vms_view,
                  'entity_type': 'Cloud.ru Advanced',
                  'entity_title': "Виртуальная машина в облаке Advanced",
                  'dc': vm.dc
              }
          )]
      )