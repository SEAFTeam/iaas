functions:
  reverse.enterprise:
    edrs: >
      (
          $domain := $.domain;
          $edr_entity_matcher := /.*\.edrs$/;
          $domain_matcher := $eval('/^' & $domain & '.*/');
          $edr_entity := $$.entities.$spread()[$edr_entity_matcher($keys())].$keys()[0];
          $edrs := $$.$spread()[$edr_entity_matcher($keys())].*.$spread()[$domain_matcher($keys())];
          [[$edrs.$spread().{
              'id': $keys(),
              'edr': *
          }].(
              {
                  'id': id,
                  'system_id': edr.system_id,
                  'hosts': edr.hosts,
                  'edr_link': '/entities/' & $edr_entity & '/card?id=' & id,
                  'entity': $edr_entity
              }
          )];
      )