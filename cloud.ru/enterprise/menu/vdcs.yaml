entities:
  seaf.ta.reverse.cloud_ru.enterprise.vdcs:
    menu: >
      (
          $domain := '';
          $vdcs_entity_matcher := /.*\.enterprise\.vdcs$/;
          $vdcgroups_entity_matcher := /.*\.enterprise\.vdcgroups$/;
          $vdcs_entity := $$.entities.$spread()[$vdcs_entity_matcher($keys())].$keys()[0];
          $vdcs := $$.$spread()[$vdcs_entity_matcher($keys())].*;
          $vdcgroups_entity := $$.entities.$spread()[$vdcgroups_entity_matcher($keys())].$keys()[0];
          $vdcgroups := $$.$spread()[$vdcgroups_entity_matcher($keys())].*;
          $config := entities."seaf.ta.reverse.general".config;
          $static := [
              {
                  'location': $config.arch_menu & '/Cloud.ru/Enterprise/Реестры/VDC',
                  'link': 'entities/' & $vdcs_entity & '/list?domain=' & $domain
              }];
          $dynamic_vdc := $vdcs.$spread()[$not($keys() in $vdcgroups.*.vdcs.id)].(
                $id := $keys()[0];
                $name := $.*.name;
                $orgname := $.*.org_name;
                {
                    'location': $config.arch_menu & '/Cloud.ru/Enterprise/Организации/' & $orgname & '/' & $name,
                    'link': 'entities/' & $vdcs_entity & '/card?id=' & $id
                }
          );
          $dynamic_vdcgroup := $vdcs.$spread()[$keys() in $vdcgroups.*.vdcs.id].(
                $id := $keys()[0];
                $name := $.*.name;
                $vdcgroup := $vdcgroups.$spread()[$id in *.vdcs.id];
                $orgname := $.*.org_name;
                $vdcgroup.$spread().(
                  {
                      'location': $config.arch_menu & '/Cloud.ru/Enterprise/Организации/' & $orgname & '/' & $.*.name & '/' & $name,
                      'link': 'entities/' & $vdcs_entity & '/card?id=' & $id
                  }
                )
          );
          $dynamic := $append($dynamic_vdc, $dynamic_vdcgroup); 
          $append($static, $dynamic)
      )