entities:
  seaf.ta.reverse.vmwarecloud.vapps:
    menu: >
      (
          $domain := '';
          $domain_matcher := $eval('/^' & $domain & '.*/');
      
          $vapps_entity := "seaf.ta.reverse.general".config.entities.vapps.model;
          $vapps_view := "seaf.ta.reverse.general".config.entities.vms.view;
          $vdcs_entity := "seaf.ta.reverse.general".config.entities.vdcs.model;
          $dcs_entity := "seaf.ta.reverse.general".config.entities.dc.model;
          $org_entity := "seaf.ta.reverse.general".config.entities.orgs.model;
          $vdcgroups_entity := "seaf.ta.reverse.general".config.entities.vdcgroups.model;
      
          $dcs := $lookup($, $dcs_entity)[$domain_matcher($keys())];
          $vapps := $lookup($, $vapps_entity)[$domain_matcher($keys())];
          $vdcs := $lookup($, $vdcs_entity)[$domain_matcher($keys())];
          $vdcgroups := $lookup($, $vdcgroups_entity)[$domain_matcher($keys())];
          $orgs := $lookup($, $org_entity)[$domain_matcher($keys())];
      
          $config := "seaf.ta.reverse.general".config;
          $menu := $vapps.$spread().(
              $id := $keys();
              $name := $.*.name;
              $vdc_id := $.*.vdc_id;
              $vdcname := $vdcs.$spread()[$keys() = $vdc_id].*.name;
              $org_id := $vdcs.$spread()[$keys() = $vdc_id].*.org_id;
              $org := $orgs.$spread()[$keys() = $org_id];
              $orgname := $org.*.name;
              $dc := $dcs.$spread()[$keys() = $org.*.DC];
              $vdc_id in $vdcgroups.*.vdcs.id ? (
                  $vdcgroup := $vdcgroups.$spread()[$vdc_id in *.vdcs.id];
                  $vdcgroup.$spread().(
                      [
                          {
                              'location': $config.arch_menu & '/' & $dc.*.title & '/Облако VMware/Организации/' & $orgname & '/' & $.*.name & '/' & $vdcname & '/vApps/' & $name,
                              'link': 'entities/' & $vapps_view & '/card?id=' & $id
                          },
                          {
                              'location': $config.arch_menu & '/' & $dc.*.title & '/Облако VMware/Организации/' & $orgname & '/' & $.*.name & '/' & $vdcname & '/vApps',
                              'link': 'entities/' & $vapps_view & '/list?vdc_id=' & $vdc_id
                          }
                      ]
                  )
              ) : (
                  [
                      {
                          'location': $config.arch_menu & '/' & $dc.*.title & '/Облако VMware/Организации/' & $orgname & '/' & $vdcname & '/vApps/' & $name,
                          'link': 'entities/' & $vapps_view & '/card?id=' & $id
                      },
                      {
                          'location': $config.arch_menu & '/' & $dc.*.title & '/Облако VMware/Организации/' & $orgname & '/' & $vdcname & '/vApps',
                          'link': 'entities/' & $vapps_view & '/list?vdc_id=' & $vdc_id
                      }
                  ]
              )
          );
          $distinct($menu) 
      )