functions:
    reverse_vmwarecloud_egws_nat:
        title: Список Edge NAT
        params:
            - alias: dataset
              type: object
              title: Озеро данных
              required: true  # Признак обязательности параметра функции
            - alias: domain
              type: string
              title: Домен организации
              required: false  # Признак обязательности параметра функции
        code: >
            (
                $domain := domain;
                $domain_matcher := $eval('/^' & $domain & '.*/');
            
                $egws_entity := dataset."seaf.ta.reverse.general".config.entities.egws.model;
                $egws_view := dataset."seaf.ta.reverse.general".config.entities.egws.view;
                $egws_nat_entity := dataset."seaf.ta.reverse.general".config.entities.egws_nat.model;
                $egws_nat_view := dataset."seaf.ta.reverse.general".config.entities.egws_nat.view;
                $dcs_entity := dataset."seaf.ta.reverse.general".config.entities.dc.model;
                $orgs_entity := dataset."seaf.ta.reverse.general".config.entities.orgs.model;
                
                $egws := $lookup(dataset, $egws_entity)[$domain_matcher($keys())];
                $egws_nat := $lookup(dataset, $egws_nat_entity)[$domain_matcher($keys())];
                $orgs := $lookup(dataset, $orgs_entity)[$domain_matcher($keys())];
                $dcs := $lookup(dataset, $dcs_entity)[$domain_matcher($keys())];
                        
                [[$egws_nat.$spread().{
                    'id': $keys(),
                    'nat': *
                }].(
                    $gw_id := nat.gw_id;
                    $egw := $egws[$keys() = $gw_id];
                    $org_id := $egw.*.org_id;
                    $org := $orgs.$spread()[$keys() = $org_id];
                    $orgname := $org.*.name;
                    $dc := $dcs.$spread()[$keys() = $org.*.DC];
                    {
                        'id': id,
                        'short_id': nat.id,
                        'gw_id': nat.gw_id,
                        'name': nat.name,
                        'description': nat.description,
                        'type': nat.type,
                        'enabled': nat.enabled,
                        'external_address': nat.external_address,
                        'internal_address': nat.internal_address,
                        'system_rule': nat.system_rule,
                        'snat_dst_address': nat.snat_dst_address,
                        'dnat_ext_port': nat.dnat_ext_port,
                        'fw_match': nat.fw_match,
                        'egw_name': $egw.*.name,
                        'egw_id': $egw.$keys()[0],
                        'org_id': $org_id,
                        'org_name': $orgname,
                        'link': '/entities/' & $egws_nat_view & '/' & $lowercase(nat.type) & '_schema?id=' & id,
                        'egw_link': '/entities/' & $egws_view & '/card?id=' & $egw.*.id,
                        'entity': $egws_nat_view,
                        'entity_type': 'VMware Cloud',
                        'entity_name': 'Правила FW на Edge в облаке VMware',
                        'DC': $dc.$keys()[0],
                        'dc_name': $dc.*.title
                    }
                )]
            )